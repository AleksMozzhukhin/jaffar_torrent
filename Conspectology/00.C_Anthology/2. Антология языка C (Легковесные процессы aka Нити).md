Этот раздел является логическим продолжением [раздела про процессы](<1. Антология языка C (Многопроцессное программирование).md>), только на этот раз мы будем рассматривать не полноценные процессы, а так называемые *Нити* (pthreads).

# Общая информация о нитях

Легковесные процессы (далее нити) создаются и используются в рамках одного процесса. Т.е. вне этого процесса созданные нити будут не видны и взаимодействовать с ними невозможно.

Все нити внутри одного процесса разделяют между собой:
- Глобальные переменные
- Контекст процесса (PID, PPID, сигналы и т.д.)

Однако у каждой нити получается свои:
- Стек
- Регистры процессора (включая счётчик команд)

| **Характеристика**  | **Процесс**                                                   | **Нить**                                                    |
| ------------------- | ------------------------------------------------------------- | ----------------------------------------------------------- |
| Пространство памяти | Отдельное                                                     | Совместное                                                  |
| Создание            | Ресурсоёмкое                                                  | Менее ресурсоёмкое                                          |
| Коммуникация        | Требует использования средств межпроцессорного взаимодействия | Через локальную память процесса                             |
| Изоляция            | Высокая (ошибка в одном процессе не влияет на другой)         | Низкая (ошибка в одной нити может повлиять на весь процесс) |
# Создание нитей

Для работы с нитями используется библиотека `pthread`, подключение которой осуществляется через соответствующий хедер-файл (#include pthread.h).

Для создания нити используется функция `pthread_create`. Общий её прототип: 
`int pthread_create(pthread_t *tid, const pthread_attr_t *attr, void* (*start)(void *), void *arg)` 
Она принимает следующие параметры:

1. Указатель на переменную типа `pthread_t`, где будет сохранен идентификатор новой нити.
2. Указатель на атрибуты нити (можно передать `NULL` для использования значений по умолчанию).
3. Указатель на функцию, которую будет выполнять нить.
4. Аргумент, передаваемый в функцию нити.

Пример:
``` C
#include <pthread.h>
#include <stdio.h>
#include <stdlib.h>

// Функция, выполняемая нитью
void* thread_function(void* arg) {
    int *num = (int*) arg;
    printf("Нить получила число: %d\n", *num);
    pthread_exit(NULL);
}

int main() {
    pthread_t thread;
    int number = 42;
    int result;

    // Создание нити
    result = pthread_create(&thread, NULL, thread_function, &number);
    if (result != 0) {
        printf(stderr, "Ошибка создания нити\n");
        exit(EXIT_FAILURE);
    }

    // Ожидание завершения нити
    pthread_join(thread, NULL);
    printf("Нить завершена\n");
    return 0;
}

```

# Завершение нитей

Нить может завершиться самостоятельно, вызвав `pthread_exit`, или завершиться при завершении функции, переданной в `pthread_create`. Также главный поток может ожидать завершения нити с помощью `pthread_join`.

```C
#include <pthread.h>
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>

void* thread_function(void* arg) {
    int method = *(int*)arg;

    if (method == 0) {
        printf("Нить %lu: Завершение через возврат из функции.\n", pthread_self());
        // Выполнение некоторой работы
        sleep(1);
        printf("Нить %lu: Завершена возвратом из функции.\n", pthread_self());
        return NULL; // Завершение нити через возврат
    } else if (method == 1) {
        printf("Нить %lu: Завершение через pthread_exit.\n", pthread_self());
        // Выполнение некоторой работы
        sleep(1);
        printf("Нить %lu: Завершена вызовом pthread_exit.\n", pthread_self());
        pthread_exit(NULL); // Завершение нити через pthread_exit
    } else {
        printf("Нить %lu: Неизвестный метод завершения.\n", pthread_self());
        return NULL;
    }
}

int main() {
    pthread_t tid[2];
    int methods[2] = {0, 1}
    int result;
	
	// Создание нитей и запись их идентификаторов в массив
	for(int i=0; i<2; i++){
	    result = pthread_create(&tid[i], NULL, thread_function, &methods[i]);
	    if (result != 0) {
	        fprintf(stderr, "Ошибка создания первой нити\n");
	        exit(EXIT_FAILURE);
	    }
	}
	
	// Ожидание завершения нитей
    for (int i=0; i<2; i++){
	    pthread_join(tid[i], NULL);
	    printf("Главный поток: нить номер %d завершена.\n", i);
	}

    printf("Главный поток: Завершение программы.\n");
    return 0;
}

```
